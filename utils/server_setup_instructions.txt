### Инструкция по настройке SSL для домена YOUR_DOMAIN и обработки уведомлений оплаты

## 1. Подключение к серверу
Подключитесь к вашему серверу (IP: YOUR_SERVER_IP) через SSH:
```
ssh username@YOUR_SERVER_IP
```

## 2. Установка необходимого ПО
```bash
# Обновите пакеты
sudo apt update
sudo apt upgrade -y

# Установите Nginx, если его еще нет
sudo apt install nginx -y

# Установите Certbot для получения SSL-сертификата
sudo apt install certbot python3-certbot-nginx -y
```

## 3. Получение SSL-сертификата
```bash
# Получите сертификат с помощью Certbot
sudo certbot --nginx -d YOUR_DOMAIN

# Следуйте инструкциям в интерактивном режиме:
# - Укажите email для уведомлений
# - Примите условия использования
# - Выберите перенаправление HTTP на HTTPS
```

## 4. Настройка Nginx
Создайте файл конфигурации Nginx:
```bash
sudo nano /etc/nginx/sites-available/YOUR_DOMAIN
```

Скопируйте туда содержимое файла nginx_config.conf, который я создал для вас.

```bash
# Активируйте конфигурацию
sudo ln -s /etc/nginx/sites-available/YOUR_DOMAIN /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default # Удалите дефолтную конфигурацию, если она мешает

# Проверьте конфигурацию Nginx
sudo nginx -t

# Перезапустите Nginx
sudo systemctl restart nginx
```

## 5. Настройка файрвола
```bash
# Установите ufw, если его нет
sudo apt install ufw -y

# Настройте правила
sudo ufw allow 'Nginx Full'  # Разрешает HTTP и HTTPS
sudo ufw allow ssh           # Разрешает SSH
sudo ufw allow 8080          # Разрешает порт для вашего бота (можно убрать, если используете только прокси через Nginx)

# Включите файрвол
sudo ufw enable
```

## 6. Обновление настроек бота
Обновите файл .env в директории вашего бота:
```bash
# Перейдите в директорию бота
cd /путь/к/боту

# Обновите переменные окружения
nano .env
```

Измените переменную `WEBHOOK_RETURN_URL` на:
```
WEBHOOK_RETURN_URL=YOUR_PAYMENT_RETURN_URL
```

## 7. Настройка YooKassa
1. Войдите в личный кабинет YooKassa
2. Перейдите в раздел настроек уведомлений
3. Добавьте URL для уведомлений: `YOUR_PAYMENT_NOTIFICATION_URL`
4. Сохраните настройки

## 8. Перезапуск бота
```bash
# Если вы используете systemd для управления ботом:
sudo systemctl restart your-bot-service.service

# Или просто перезапустите скрипт бота
# Если запускаете через screen или tmux, сначала остановите текущую сессию
```

## 9. Проверка
1. Откройте в браузере `YOUR_PAYMENT_RETURN_URL` - должна открыться страница без ошибок SSL
2. Попробуйте провести тестовый платеж через бота
3. Проверьте логи на наличие ошибок:
   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

## Дополнительная информация
- Certbot автоматически настраивает обновление сертификата
- Если возникают проблемы с доступом к порту 8080, убедитесь, что ваш веб-сервер бота запущен и слушает на 0.0.0.0:8080, а не только на localhost

## Решение возможных проблем
1. Если бот не получает уведомления, проверьте:
   - Логи Nginx: `sudo tail -f /var/log/nginx/error.log`
   - Логи бота
   - Правильность настройки URL уведомлений в личном кабинете YooKassa

2. Если сертификат не получается установить:
   - Убедитесь, что DNS домена правильно указывает на ваш IP
   - Проверьте, что порты 80 и 443 открыты на файрволе
   - Временно отключите файрвол для тестирования: `sudo ufw disable` 
